# nacos解惑

本文的目的是为了解答在学习nacos中的一些问题.

## nacos机制,如何实现

- 在集群环境下,如何保证服务在不同的节点同步

    针对这个问题,首先nacos naming默认为ap模式,采用distro协议实现.在distro协议中,每个服务节点只负责一部分数据.所以当出现服务注册,取消注册时,首先
    负责节点完成客户端请求,然后异步发送给其他集群节点.异步任务做了优化,采用延迟执行+数据批量发送的机制来减少发送次数,而且频繁的连接会带来大量
    time_wait连接,可能导致超过ulimit上限,以及端口被用完,无法创建连接的问题.
    回到异步发送这个话题,异步发送并不保证一定发送成功,所以还有定时任务```DistroVerifyTask```来同步不同集群节点的数据.

- 在集群环境下,一个服务从健康到不健康,然后删除需要经历多久

    在默认配置下,心跳超时时间为15s,而心跳间隔为5s.定时任务5s执行一次,最后心跳时间超过15s,服务被设置为不健康.如果参数```nacos.naming.expireInstance```
    开启,30s后删除.
    这里要明确一下,在nacos中服务有两个对象,```service```以及```instance```.```service```是个抽象的对象,不针对具体的实例.```instance```才是具体的注册服务.
    服务是否健康对应的对象就是```instance```
    当一个```service```对应的实例```instance```全部被删除后,有别的定时任务以及参数来控制是否清除```service```.具体的任务为```EmptyServiceAutoClean```

- 在集群环境下,```DistroVerifyTask```与```ServiceReporter```是否有些重复

    首先我们先明确这两个定时任务承担什么样的任务.```DistroVerifyTask```是distro协议下的一个定时任务,用来同步所有的distro持久化数据.
    ```ServiceReporter```是```ServiceManager```中的一个定时任务,主要用来同步服务的健康状况,但是未注册的实例无法同步.

- nacos客户端是如何从服务端同步服务的

    nocas提供了2种方式,客户端定时拉取以及服务端主动推送.默认情况下,


## 性能问题

## 如何排查